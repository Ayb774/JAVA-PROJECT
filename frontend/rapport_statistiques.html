<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapports et Statistiques</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="navbar">
    <h1 class="logo">DevManager</h1>
    <nav class="nav-links">
        <button class="menu-button" onclick="window.location.href='index.html'">Dashboard</button>
        <button class="menu-button" onclick="window.location.href='rapport_statistiques.html'">Rapports et Statistiques</button>
        <button class="menu-button" onclick="window.location.href='ajouter_programmeur.html'">Ajouter Programmeur</button>
    </nav>
</div>

<main>
    <section class="dashboard">
        <h2>Rapports et Statistiques</h2>

        <div id="key-metrics" class="key-metrics">
            <p><strong>Salaire moyen : </strong><span id="average-salary">0</span> €</p>
            <p><strong>Prime moyenne : </strong><span id="average-bonus">0</span> €</p>
        </div>

        <div class="chart-navigation">
            <div class="chart-controls">
                <button id="prev-chart" class="arrow-button" onclick="switchChart(-1)">◀</button>
                <button id="next-chart" class="arrow-button" onclick="switchChart(1)">▶</button>
            </div>
            <h3 id="chart-title" class="chart-title">Titre du Graphique</h3>
            <div class="chart-wrapper">
                <canvas id="dynamic-chart"></canvas>
            </div>
        </div>
    </section>
</main>

<script>
    const apiUrl = "http://localhost:8080/api/programmeurs/";
    let currentChartIndex = 0;
    let charts = [];
    let chartInstance;
    const chartTitles = ["Distribution des Salaires", "Tranches d'Âge", "Évolution des Salaires"];

    async function fetchProgrammeurs() {
        try {
            const response = await fetch(apiUrl);
            if (!response.ok) {
                throw new Error(`Erreur HTTP : ${response.status}`);
            }
            return await response.json();
        } catch (error) {
            console.error("Erreur lors de la récupération des programmeurs :", error);
        }
    }

    function createChart(type, data, options) {
        const ctx = document.getElementById('dynamic-chart').getContext('2d');
        return new Chart(ctx, {
            type,
            data,
            options
        });
    }

    async function setupCharts() {
        const programmeurs = await fetchProgrammeurs();

        if (!programmeurs) return;

        const totalProgrammers = programmeurs.length;
        const totalSalary = programmeurs.reduce((acc, prog) => acc + prog.salaire, 0);
        const totalBonus = programmeurs.reduce((acc, prog) => acc + prog.prime, 0);
        const averageSalary = totalProgrammers > 0 ? (totalSalary / totalProgrammers).toFixed(2) : 0;
        const averageBonus = totalProgrammers > 0 ? (totalBonus / totalProgrammers).toFixed(2) : 0;

        document.getElementById('average-salary').textContent = averageSalary;
        document.getElementById('average-bonus').textContent = averageBonus;

        const salaryData = programmeurs.map(prog => prog.salaire);
        const ageData = programmeurs.map(prog => new Date().getFullYear() - parseInt(prog.anNaissance, 10));

        charts = [
            {
                type: 'bar',
                data: {
                    labels: programmeurs.map(prog => prog.nom + ' ' + prog.prenom),
                    datasets: [{
                        label: 'Salaire (€)',
                        data: salaryData,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            },
            {
                type: 'pie',
                data: {
                    labels: ['<25 ans', '25-35 ans', '35-50 ans', '>50 ans'],
                    datasets: [{
                        label: 'Tranches d\'Âge',
                        data: [
                            ageData.filter(age => age < 25).length,
                            ageData.filter(age => age >= 25 && age <= 35).length,
                            ageData.filter(age => age > 35 && age <= 50).length,
                            ageData.filter(age => age > 50).length
                        ],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.2)',
                            'rgba(54, 162, 235, 0.2)',
                            'rgba(255, 206, 86, 0.2)',
                            'rgba(75, 192, 192, 0.2)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true
                }
            },
            {
                type: 'line',
                data: {
                    labels: programmeurs.map(prog => prog.nom + ' ' + prog.prenom),
                    datasets: [{
                        label: 'Évolution du Salaire (€)',
                        data: salaryData,
                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            }
        ];

        loadChart();
    }

    function loadChart() {
        if (chartInstance) {
            chartInstance.destroy();
        }
        document.getElementById('chart-title').textContent = chartTitles[currentChartIndex];
        chartInstance = createChart(charts[currentChartIndex].type, charts[currentChartIndex].data, charts[currentChartIndex].options);
    }

    function switchChart(direction) {
        currentChartIndex = (currentChartIndex + direction + charts.length) % charts.length;
        loadChart();
    }

    // Initialisation
    setupCharts();
</script>

</body>
</html>
